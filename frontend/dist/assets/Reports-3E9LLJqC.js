import{_ as E,u as F,a as A,r as i,o as j,c as p,b as e,d as x,w as h,v as L,e as I,t as f,F as B,f as H,g}from"./index---ni_Qsg.js";const M={class:"admin-container"},N={class:"admin-card"},Y={class:"admin-form-group"},P={key:0,class:"admin-form-grid"},q={class:"admin-form-group"},z={class:"admin-form-group"},G={class:"admin-form-group"},J=["disabled"],K={key:0,class:"admin-card mt-4"},Q={class:"admin-table-responsive"},W={class:"admin-table"},X={class:"admin-button-group"},Z=["onClick"],tt={key:1,class:"admin-card mt-4"},et={__name:"Reports",setup(at){F();const _=A(),u=i(!1),r=i("daily"),S=i("excel"),d=i(""),c=i(""),$=i([]),b=i([]);function O(a){return{daily:"Ежедневный",weekly:"Еженедельный",monthly:"Ежемесячный",custom:"Произвольный период"}[a]||a}function R(a){if(!a)return"-";try{return new Date(a).toLocaleDateString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}catch(t){return console.error("Ошибка при форматировании даты:",t),a}}async function C(){if(r.value==="custom"&&(!d.value||!c.value)){alert("Пожалуйста, укажите даты начала и окончания периода");return}u.value=!0;try{const a=new Date;let t,o,s="";switch(r.value){case"daily":const n=new Date,v=n.getFullYear(),D=n.getMonth(),y=n.getDate();s=`${n.toLocaleDateString("ru-RU")}`,t=new Date(v,D,y,0,0,0,0),o=new Date(v,D,y,23,59,59,999),console.log("Формирование ежедневного отчета за текущий день:",n.toLocaleDateString("ru-RU"),`
Даты в ISO формате:`,t.toISOString(),"по",o.toISOString());break;case"weekly":t=new Date(a),t.setDate(a.getDate()-a.getDay()+1),t.setHours(0,0,0,0),o=new Date(t),o.setDate(t.getDate()+6),o.setHours(23,59,59,999),s=`${t.toLocaleDateString("ru-RU")} - ${o.toLocaleDateString("ru-RU")}`;break;case"monthly":t=new Date(a.getFullYear(),a.getMonth(),1),t.setHours(0,0,0,0),o=new Date(a.getFullYear(),a.getMonth()+1,0),o.setHours(23,59,59,999),s=`${t.toLocaleDateString("ru-RU")} - ${o.toLocaleDateString("ru-RU")}`;break;case"custom":if(!d.value||!c.value){alert("Пожалуйста, укажите начальную и конечную даты"),u.value=!1;return}t=new Date(d.value),t.setHours(0,0,0,0),o=new Date(c.value),o.setHours(23,59,59,999),s=`${t.toLocaleDateString("ru-RU")} - ${o.toLocaleDateString("ru-RU")}`;break}const w=t.toISOString().split("T")[0],k=o.toISOString().split("T")[0];let l,m;r.value==="daily"?(l=new Date().toISOString().split("T")[0],m=l):(l=w,m=k),console.log(`Формирование отчета ${r.value} за период: ${l} - ${m}`),await _.fetchOrdersByCreatedAtRange(l,m),$.value=_.orders.map(n=>{const v=n.Service&&n.Service.length>0?n.Service[0].DtVisit:n.CreatedAt;return{"ID заказа":n.Id,"Штрих-код":n.OrderBarcode,Имя:n.VisitorName1,Фамилия:n.VisitorName2,Телефон:n.VisitorPhone,Статус:T(n.OrderStateId),Стоимость:n.Cost,"Дата создания заказа":R(v)}}),S.value==="excel"&&U($.value,`Отчет_${r.value}_${s.replace(/\s/g,"_")}`),b.value.unshift({id:b.value.length+1,name:`Отчет ${O(r.value).toLowerCase()}`,type:r.value,period:s,createdAt:new Date().toISOString(),url:"#",format:S.value,data:$.value}),alert("Отчет успешно сформирован")}catch(a){console.error("Ошибка при формировании отчета:",a),alert("Произошла ошибка при формировании отчета")}finally{u.value=!1}}function T(a){return{0:"Новый",5:"Оплачен",2:"Отменен",3:"Возвращен",4:"Использован"}[a]||`Статус ${a}`}function U(a,t){if(!a||a.length===0){alert("Нет данных для формирования отчета");return}try{const o=Object.keys(a[0]);let s=o.join(";")+`
`;a.forEach(m=>{const n=o.map(v=>{const D=String(m[v]||""),y=D.replace(/"/g,'""');return D.includes(";")?`"${y}"`:y});s+=n.join(";")+`
`});const w=new Blob([s],{type:"text/csv;charset=utf-8;"}),k=URL.createObjectURL(w),l=document.createElement("a");l.setAttribute("href",k),l.setAttribute("download",`${t}.csv`),l.style.visibility="hidden",document.body.appendChild(l),l.click(),document.body.removeChild(l)}catch(o){console.error("Ошибка при генерации Excel:",o),alert("Произошла ошибка при генерации Excel файла")}}function V(a){a.data&&a.format==="excel"?U(a.data,`Отчет_${a.type}_${a.period.replace(/\s/g,"_")}`):alert(`Скачивание отчета "${a.name}" в формате ${a.format||"PDF"}`)}return j(()=>{c.value=new Date().toISOString().split("T")[0];const a=new Date;a.setDate(a.getDate()-30),d.value=a.toISOString().split("T")[0]}),(a,t)=>(g(),p("div",M,[t[13]||(t[13]=e("h2",{class:"admin-section-title"},"Отчеты",-1)),e("div",N,[e("div",Y,[t[5]||(t[5]=e("label",{for:"reportType"},"Тип отчета:",-1)),h(e("select",{id:"reportType","onUpdate:modelValue":t[0]||(t[0]=o=>r.value=o),class:"admin-input"},t[4]||(t[4]=[e("option",{value:"daily"},"Ежедневный отчет",-1),e("option",{value:"weekly"},"Еженедельный отчет",-1),e("option",{value:"monthly"},"Ежемесячный отчет",-1),e("option",{value:"custom"},"Произвольный период",-1)]),512),[[L,r.value]])]),r.value==="custom"?(g(),p("div",P,[e("div",q,[t[6]||(t[6]=e("label",{for:"startDate"},"Дата начала:",-1)),h(e("input",{type:"date",id:"startDate","onUpdate:modelValue":t[1]||(t[1]=o=>d.value=o),class:"admin-input"},null,512),[[I,d.value]])]),e("div",z,[t[7]||(t[7]=e("label",{for:"endDate"},"Дата окончания:",-1)),h(e("input",{type:"date",id:"endDate","onUpdate:modelValue":t[2]||(t[2]=o=>c.value=o),class:"admin-input"},null,512),[[I,c.value]])])])):x("",!0),e("div",G,[t[9]||(t[9]=e("label",{for:"reportFormat"},"Формат отчета:",-1)),h(e("select",{id:"reportFormat","onUpdate:modelValue":t[3]||(t[3]=o=>S.value=o),class:"admin-input"},t[8]||(t[8]=[e("option",{value:"excel"},"Excel",-1)]),512),[[L,S.value]])]),e("button",{onClick:C,class:"admin-button primary",disabled:u.value},f(u.value?"Формирование отчета...":"Сформировать отчет"),9,J)]),b.value.length>0?(g(),p("div",K,[t[11]||(t[11]=e("h3",{class:"subsection-title"},"История отчетов",-1)),e("div",Q,[e("table",W,[t[10]||(t[10]=e("thead",null,[e("tr",null,[e("th",null,"Название отчета"),e("th",null,"Тип"),e("th",null,"Период"),e("th",null,"Дата создания"),e("th",null,"Действия")])],-1)),e("tbody",null,[(g(!0),p(B,null,H(b.value,(o,s)=>(g(),p("tr",{key:s},[e("td",null,f(o.name),1),e("td",null,f(O(o.type)),1),e("td",null,f(o.period),1),e("td",null,f(R(o.createdAt)),1),e("td",null,[e("div",X,[e("button",{onClick:w=>V(o),class:"admin-button secondary"}," Скачать ",8,Z)])])]))),128))])])])])):u.value?x("",!0):(g(),p("div",tt,t[12]||(t[12]=[e("p",{class:"text-center"},"История отчетов пуста",-1)])))]))}},nt=E(et,[["__scopeId","data-v-73d549b2"]]);export{nt as default};

databaseChangeLog:
  - changeSet:
      id: 001-create-users
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: users
      changes:
        - createTable:
            tableName: users
            columns:
              - column:
                  name: id
                  type: integer
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: user_name
                  type: varchar(50)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: password
                  type: varchar
                  constraints:
                    nullable: false
              - column:
                  name: role
                  type: varchar(20)
                  constraints:
                    nullable: false
              - column:
                  name: full_name
                  type: varchar(100)
              - column:
                  name: phone
                  type: varchar(20)
              - column:
                  name: email
                  type: varchar(100)
                  constraints:
                    unique: true
              - column:
                  name: created_at
                  type: timestamp
                  defaultValueComputed: now()
  - changeSet:
      id: 002-create-services
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: services
      changes:
        - createTable:
            tableName: services
            columns:
              - column:
                  name: id
                  type: integer
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: service_name
                  type: varchar
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: varchar
              - column:
                  name: cost
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: active_kind_id
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: is_need_visit_date
                  type: boolean
                  defaultValueBoolean: false
              - column:
                  name: is_need_visit_time
                  type: boolean
                  defaultValueBoolean: false
              - column:
                  name: dt_begin
                  type: timestamp
              - column:
                  name: dt_end
                  type: timestamp
              - column:
                  name: pro_culture_identifier
                  type: integer
              - column:
                  name: is_pro_culture_checked
                  type: boolean
                  defaultValueBoolean: false
              - column:
                  name: is_disable_edit_visit_object
                  type: boolean
                  defaultValueBoolean: false
                  constraints:
                    nullable: false
              - column:
                  name: is_disable_edit_visitor
                  type: boolean
                  defaultValueBoolean: false
                  constraints:
                    nullable: false
              - column:
                  name: is_visit_object_use_for_cost
                  type: boolean
                  defaultValueBoolean: true
                  constraints:
                    nullable: false
              - column:
                  name: is_category_visitor_use_for_cost
                  type: boolean
                  defaultValueBoolean: true
                  constraints:
                    nullable: false
              - column:
                  name: is_visitor_count_use_for_cost
                  type: boolean
                  defaultValueBoolean: true
                  constraints:
                    nullable: false
              - column:
                  name: is_use_one_category
                  type: boolean
                  defaultValueBoolean: false
                  constraints:
                    nullable: false
  - changeSet:
      id: 003-create-visit-objects
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: visit_objects
      changes:
        - createTable:
            tableName: visit_objects
            columns:
              - column:
                  name: id
                  type: integer
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: visit_object_name
                  type: varchar
                  constraints:
                    nullable: false
              - column:
                  name: is_required
                  type: boolean
                  defaultValueBoolean: false
  - changeSet:
      id: 004-create-category-visitors
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: category_visitors
      changes:
        - createTable:
            tableName: category_visitors
            columns:
              - column:
                  name: id
                  type: integer
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: category_name
                  type: varchar
                  constraints:
                    nullable: false
  - changeSet:
      id: 005-create-orders
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: orders
      changes:
        - createTable:
            tableName: orders
            columns:
              - column:
                  name: id
                  type: integer
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: order_barcode
                  type: varchar
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: order_state_id
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: user_id
                  type: integer
              - column:
                  name: visitor_name1
                  type: varchar
              - column:
                  name: visitor_name2
                  type: varchar
              - column:
                  name: visitor_name3
                  type: varchar
              - column:
                  name: visitor_phone
                  type: varchar
              - column:
                  name: visitor_mail
                  type: varchar
              - column:
                  name: created_at
                  type: timestamp
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: is_simple_mode
                  type: boolean
                  defaultValueBoolean: false
                  constraints:
                    nullable: false
              - column:
                  name: order_site_id
                  type: varchar
              - column:
                  name: visitor_site_id
                  type: varchar
              - column:
                  name: visitor_address
                  type: varchar
              - column:
                  name: visitor_document_name
                  type: varchar
              - column:
                  name: visitor_document_serial
                  type: varchar
              - column:
                  name: visitor_document_number
                  type: varchar
              - column:
                  name: comment
                  type: varchar
              - column:
                  name: dt_drop
                  type: timestamp
              - column:
                  name: cost
                  type: integer
                  defaultValueNumeric: 0
  - changeSet:
      id: 006-create-order-services
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: order_services
      changes:
        - createTable:
            tableName: order_services
            columns:
              - column:
                  name: id
                  type: integer
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: order_id
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: service_id
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: cost
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: dt_visit
                  type: timestamp
              - column:
                  name: service_state_id
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: service_count
                  type: integer
                  defaultValueNumeric: 1
                  constraints:
                    nullable: false
              - column:
                  name: dt_drop
                  type: timestamp
              - column:
                  name: pro_culture_guid
                  type: varchar
  - changeSet:
      id: 007-create-action-logs
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: action_logs
      changes:
        - createTable:
            tableName: action_logs
            columns:
              - column:
                  name: id
                  type: integer
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: user_id
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: action_type
                  type: varchar
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: varchar
              - column:
                  name: created_at
                  type: timestamp
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: actor_name
                  type: varchar(255)
        - addForeignKeyConstraint:
            baseColumnNames: user_id
            baseTableName: action_logs
            constraintName: fk_action_logs_users
            referencedColumnNames: id
            referencedTableName: users
  - changeSet:
      id: 008-create-excursion-log
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: excursion_log
      changes:
        - createTable:
            tableName: excursion_log
            columns:
              - column:
                  name: id
                  type: integer
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: excursion_log_internet_number
                  type: bigint
              - column:
                  name: org_name
                  type: varchar
              - column:
                  name: contact_person_name
                  type: varchar
              - column:
                  name: contact_person_phone
                  type: varchar
              - column:
                  name: contact_person_mail
                  type: varchar
              - column:
                  name: service_id
                  type: bigint
                  constraints:
                    nullable: false
              - column:
                  name: dt_date
                  type: timestamp
                  constraints:
                    nullable: false
              - column:
                  name: comment
                  type: varchar
              - column:
                  name: created_at
                  type: timestamp
                  defaultValueComputed: CURRENT_TIMESTAMP
        - addForeignKeyConstraint:
            baseColumnNames: service_id
            baseTableName: excursion_log
            constraintName: fk_excursion_log_service
            referencedColumnNames: id
            referencedTableName: services
  - changeSet:
      id: 009-create-excursion-log-visit-object
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: excursion_log_visit_object
      changes:
        - createTable:
            tableName: excursion_log_visit_object
            columns:
              - column:
                  name: id
                  type: integer
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: excursion_log_id
                  type: bigint
                  constraints:
                    nullable: false
              - column:
                  name: visit_object_id
                  type: bigint
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseColumnNames: excursion_log_id
            baseTableName: excursion_log_visit_object
            constraintName: fk_excursion_log_vo_log
            referencedColumnNames: id
            referencedTableName: excursion_log
        - addForeignKeyConstraint:
            baseColumnNames: visit_object_id
            baseTableName: excursion_log_visit_object
            constraintName: fk_excursion_log_vo_obj
            referencedColumnNames: id
            referencedTableName: visit_objects
  - changeSet:
      id: 010-create-excursion-log-visitor
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: excursion_log_visitor
      changes:
        - createTable:
            tableName: excursion_log_visitor
            columns:
              - column:
                  name: id
                  type: integer
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: excursion_log_id
                  type: bigint
                  constraints:
                    nullable: false
              - column:
                  name: category_visitor_id
                  type: bigint
                  constraints:
                    nullable: false
              - column:
                  name: visitor_count
                  type: integer
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseColumnNames: excursion_log_id
            baseTableName: excursion_log_visitor
            constraintName: fk_excursion_log_visitor_log
            referencedColumnNames: id
            referencedTableName: excursion_log
        - addForeignKeyConstraint:
            baseColumnNames: category_visitor_id
            baseTableName: excursion_log_visitor
            constraintName: fk_excursion_log_visitor_cat
            referencedColumnNames: id
            referencedTableName: category_visitors
  - changeSet:
      id: 011-create-order-service-visit-object
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: order_service_visit_object
      changes:
        - createTable:
            tableName: order_service_visit_object
            columns:
              - column:
                  name: id
                  type: integer
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: order_service_id
                  type: bigint
                  constraints:
                    nullable: false
              - column:
                  name: visit_object_id
                  type: bigint
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: order_service_visit_object
            baseColumnNames: order_service_id
            referencedTableName: order_services
            referencedColumnNames: id
            constraintName: fk_order_service_visit_object_os
        - addForeignKeyConstraint:
            baseTableName: order_service_visit_object
            baseColumnNames: visit_object_id
            referencedTableName: visit_objects
            referencedColumnNames: id
            constraintName: fk_order_service_visit_object_vo
  - changeSet:
      id: 012-create-order-service-visitor
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: order_service_visitor
      changes:
        - createTable:
            tableName: order_service_visitor
            columns:
              - column:
                  name: id
                  type: integer
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: order_service_id
                  type: bigint
                  constraints:
                    nullable: false
              - column:
                  name: category_visitor_id
                  type: bigint
                  constraints:
                    nullable: false
              - column:
                  name: visitor_count
                  type: integer
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: order_service_visitor
            baseColumnNames: order_service_id
            referencedTableName: order_services
            referencedColumnNames: id
            constraintName: fk_order_service_visitor_os
        - addForeignKeyConstraint:
            baseTableName: order_service_visitor
            baseColumnNames: category_visitor_id
            referencedTableName: category_visitors
            referencedColumnNames: id
            constraintName: fk_order_service_visitor_cv
  - changeSet:
      id: 013-create-payments
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: payments
      changes:
        - createTable:
            tableName: payments
            columns:
              - column:
                  name: id
                  type: integer
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: order_id
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: payment_type
                  type: varchar
                  constraints:
                    nullable: false
              - column:
                  name: amount
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: varchar
                  constraints:
                    nullable: false
              - column:
                  name: transaction_id
                  type: varchar
                  constraints:
                    unique: true
              - column:
                  name: created_at
                  type: timestamp
                  defaultValueComputed: CURRENT_TIMESTAMP
  - changeSet:
      id: 014-create-prices
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: prices
      changes:
        - createTable:
            tableName: prices
            columns:
              - column:
                  name: id
                  type: integer
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: service_id
                  type: integer
              - column:
                  name: visit_object_id
                  type: integer
              - column:
                  name: category_visitor_id
                  type: integer
              - column:
                  name: cost
                  type: integer
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: prices
            baseColumnNames: service_id
            referencedTableName: services
            referencedColumnNames: id
            constraintName: fk_prices_services
        - addForeignKeyConstraint:
            baseTableName: prices
            baseColumnNames: visit_object_id
            referencedTableName: visit_objects
            referencedColumnNames: id
            constraintName: fk_prices_visit_objects
        - addForeignKeyConstraint:
            baseTableName: prices
            baseColumnNames: category_visitor_id
            referencedTableName: category_visitors
            referencedColumnNames: id
            constraintName: fk_prices_category_visitors
  - changeSet:
      id: 015-create-pro-culture-links
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: pro_culture_links
      changes:
        - createTable:
            tableName: pro_culture_links
            columns:
              - column:
                  name: id
                  type: bigint
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: order_service_id
                  type: bigint
              - column:
                  name: order_id
                  type: bigint
              - column:
                  name: seat_id
                  type: bigint
              - column:
                  name: pro_culture_guid
                  type: varchar
                  constraints:
                    nullable: false
  - changeSet:
      id: 016-create-requisite-info
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: requisite_info
      changes:
        - createTable:
            tableName: requisite_info
            columns:
              - column:
                  name: id
                  type: integer
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: name
                  type: varchar
                  constraints:
                    nullable: false
              - column:
                  name: city
                  type: varchar
              - column:
                  name: address
                  type: varchar
              - column:
                  name: phone1
                  type: varchar
              - column:
                  name: fax
                  type: varchar
              - column:
                  name: dt_begin
                  type: time
              - column:
                  name: dt_end
                  type: time
  - changeSet:
      id: 017-create-seance-grid
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: seance_grid
      changes:
        - createTable:
            tableName: seance_grid
            columns:
              - column:
                  name: id
                  type: integer
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: dt_begin
                  type: time
                  constraints:
                    nullable: false
              - column:
                  name: dt_end
                  type: time
                  constraints:
                    nullable: false
  - changeSet:
      id: 018-create-sold-services
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: sold_services
      changes:
        - createTable:
            tableName: sold_services
            columns:
              - column:
                  name: id
                  type: bigint
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: order_service_id
                  type: bigint
                  constraints:
                    nullable: false
              - column:
                  name: barcode
                  type: varchar
              - column:
                  name: service_state_id
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: payment_kind_id
                  type: integer
              - column:
                  name: dt_active
                  type: timestamp
  - changeSet:
      id: 019-create-system-info
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: system_info
      changes:
        - createTable:
            tableName: system_info
            columns:
              - column:
                  name: id
                  type: integer
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: name
                  type: varchar
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: varchar
                  constraints:
                    nullable: false
              - column:
                  name: major
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: minor
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: release
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: build
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: dt_licence_finish
                  type: timestamp
                  constraints:
                    nullable: false
  - changeSet:
      id: 020-create-org
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: org
      changes:
        - createTable:
            tableName: org
            columns:
              - column:
                  name: id
                  type: integer
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: name
                  type: varchar
                  constraints:
                    nullable: false
              - column:
                  name: city
                  type: varchar
              - column:
                  name: address
                  type: varchar
              - column:
                  name: phone1
                  type: varchar
              - column:
                  name: phone2
                  type: varchar
              - column:
                  name: fax
                  type: varchar
              - column:
                  name: dt_begin
                  type: varchar
              - column:
                  name: dt_end
                  type: varchar
  - changeSet:
      id: 021-create-gate-info
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            tableExists:
              tableName: gate_info
      changes:
        - createTable:
            tableName: gate_info
            columns:
              - column:
                  name: id
                  type: integer
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: name
                  type: varchar
                  constraints:
                    nullable: false
              - column:
                  name: version
                  type: varchar
                  constraints:
                    nullable: false
              - column:
                  name: major
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: minor
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: release
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: build
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: dt_licence_finish
                  type: timestamp
                  constraints:
                    nullable: false
  - changeSet:
      id: rename-created-at-to-created
      author: m_chelyshev
      preConditions:
        onFail: MARK_RAN
        onError: HALT
        columnExists:
          tableName: orders
          columnName: created_at
      changes:
        - renameColumn:
            tableName: orders
            oldColumnName: created_at
            newColumnName: created
            columnDataType: timestamp
  - changeSet:
      id: add-updated-column-orders
      author: m_chelyshev
      preConditions:
        onFail: MARK_RAN
        not:
          columnExists:
            tableName: orders
            columnName: updated
      changes:
        - addColumn:
            tableName: orders
            columns:
              - column:
                  name: updated
                  type: timestamp
                  defaultValueComputed: CURRENT_TIMESTAMP
  - changeSet:
      id: add-data-column-to-orders
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            columnExists:
              tableName: orders
              columnName: data
      changes:
        - addColumn:
            tableName: orders
            columns:
              - column:
                  name: data
                  type: bytea
  - changeSet:
      id: add-order-id-and-status-to-orders
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            columnExists:
              tableName: orders
              columnName: order_id
        - not:
            columnExists:
              tableName: orders
              columnName: order_status
      changes:
        - addColumn:
            tableName: orders
            columns:
              - column:
                  name: order_id
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: order_status
                  type: varchar(255)
  - changeSet:
      id: create-sold-service-visit-object-table
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            - tableExists:
                tableName: sold_service_visit_object
      changes:
        - createTable:
            tableName: sold_service_visit_object
            columns:
              - column:
                  name: sold_service_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: visit_object_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: timestamp
                  defaultValueComputed: CURRENT_TIMESTAMP
        - addPrimaryKey:
            columnNames: sold_service_id, visit_object_id
            tableName: sold_service_visit_object
            constraintName: pk_sold_service_visit_object
        - addForeignKeyConstraint:
            baseTableName: sold_service_visit_object
            baseColumnNames: sold_service_id
            constraintName: fk_ssvo_sold_service
            referencedTableName: sold_services
            referencedColumnNames: id
        - addForeignKeyConstraint:
            baseTableName: sold_service_visit_object
            baseColumnNames: visit_object_id
            constraintName: fk_ssvo_visit_object
            referencedTableName: visit_objects
            referencedColumnNames: id


  - changeSet:
      id: alter-services-cost-to-double
      author: m_chelyshev
      changes:
        - modifyDataType:
            tableName: services
            columnName: cost
            newDataType: double precision

  - changeSet:
      id: alter-orders-cost-to-double
      author: m_chelyshev
      changes:
        - modifyDataType:
            tableName: orders
            columnName: cost
            newDataType: double precision

  - changeSet:
      id: alter-order-services-cost-to-double
      author: m_chelyshev
      changes:
        - modifyDataType:
            tableName: order_services
            columnName: cost
            newDataType: double precision

  - changeSet:
      id: alter-prices-cost-to-double
      author: m_chelyshev
      changes:
        - modifyDataType:
            tableName: prices
            columnName: cost
            newDataType: double precision

  - changeSet:
      id: alter-payments-amount-to-double
      author: m_chelyshev
      changes:
        - modifyDataType:
            tableName: payments
            columnName: amount
            newDataType: double precision

  - changeSet:
      id: add-service-cost-and-count-to-sold-services
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            columnExists:
              tableName: sold_services
              columnName: service_cost
        - not:
            columnExists:
              tableName: sold_services
              columnName: service_count
      changes:
        - addColumn:
            tableName: sold_services
            columns:
              - column:
                  name: service_cost
                  type: double precision
                  constraints:
                    nullable: true
              - column:
                  name: service_count
                  type: integer
                  constraints:
                    nullable: true
        - update:
            tableName: sold_services
            columns:
              - column:
                  name: service_cost
                  valueNumeric: 0
              - column:
                  name: service_count
                  valueNumeric: 0
        - addNotNullConstraint:
            tableName: sold_services
            columnName: service_cost
            columnDataType: double precision
        - addNotNullConstraint:
            tableName: sold_services
            columnName: service_count
            columnDataType: integer
  - changeSet:
      id: add-service-id-to-sold-services
      author: m_chelyshev
      preConditions:
        onFail: MARK_RAN
        not:
          columnExists:
            tableName: sold_services
            columnName: service_id
      changes:
        - addColumn:
            tableName: sold_services
            columns:
              - column:
                  name: service_id
                  type: bigint
                  constraints:
                    nullable: true
        - update:
            tableName: sold_services
            columns:
              - column:
                  name: service_id
        - addNotNullConstraint:
            tableName: sold_services
            columnName: service_id
            columnDataType: bigint
  - changeSet:
      id: add-column-visit-object-address
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            columnExists:
              tableName: visit_objects
              columnName: address
      changes:
        - addColumn:
            tableName: visit_objects
            columns:
              - column:
                  name: address
                  type: VARCHAR(255)
                  constraints:
                    nullable: true
  - changeSet:
      id: add-column-visit-object-columns
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            columnExists:
              tableName: visit_objects
              columnName: category_visitor_id
        - not:
            columnExists:
              tableName: visit_objects
              columnName: comment
      changes:
        - addColumn:
            tableName: visit_objects
            columns:
              - column:
                  name: category_visitor_id
                  type: INTEGER
                  constraints:
                    nullable: true
              - column:
                  name: comment
                  type: VARCHAR(255)
                  constraints:
                    nullable: true
  - changeSet:
      id: add-column-service-id-to-visit-objects
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            columnExists:
              tableName: visit_objects
              columnName: service_id
      changes:
        - addColumn:
            tableName: visit_objects
            columns:
              - column:
                  name: service_id
                  type: BIGINT
                  constraints:
                    nullable: true
  - changeSet:
      id: add-on-delete-cascade-to-prices-visit-object
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            foreignKeyConstraintExists:
              foreignKeyName: fk_prices_visit_objects
      changes:
        - dropForeignKeyConstraint:
            baseTableName: prices
            constraintName: fk_prices_visit_objects
        - addForeignKeyConstraint:
            baseTableName: prices
            baseColumnNames: visit_object_id
            constraintName: fk_prices_visit_objects
            referencedTableName: visit_objects
            referencedColumnNames: id
            onDelete: CASCADE
  - changeSet:
      id: add-on-delete-cascade-to-prices-category-visitor
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            foreignKeyConstraintExists:
              foreignKeyName: fk_prices_category_visitors
      changes:
        - dropForeignKeyConstraint:
            baseTableName: prices
            constraintName: fk_prices_category_visitors
        - addForeignKeyConstraint:
            baseTableName: prices
            baseColumnNames: category_visitor_id
            constraintName: fk_prices_category_visitors
            referencedTableName: category_visitors
            referencedColumnNames: id
            onDelete: CASCADE
  - changeSet:
      id: add-on-delete-cascade-to-prices-service
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            foreignKeyConstraintExists:
              foreignKeyName: fk_prices_services
      changes:
        - dropForeignKeyConstraint:
            baseTableName: prices
            constraintName: fk_prices_services
        - addForeignKeyConstraint:
            baseTableName: prices
            baseColumnNames: service_id
            constraintName: fk_prices_services
            referencedTableName: services
            referencedColumnNames: id
            onDelete: CASCADE
  - changeSet:
      id: remove-fk-from-order-service-visitor
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - foreignKeyConstraintExists:
            foreignKeyName: fk_order_service_visitor_cv
            tableName: order_service_visitor
      changes:
        - dropForeignKeyConstraint:
            baseTableName: order_service_visitor
            constraintName: fk_order_service_visitor_cv

        - addColumn:
            tableName: order_service_visitor
            columns:
              - column:
                  name: category_visitor_name
                  type: varchar(255)
  - changeSet:
      id: drop-category-visitor-id-column-if-needed
      author: m_chelyshev
      changes:
        - dropColumn:
            columnName: category_visitor_id
            tableName: order_service_visitor
  - changeSet:
      id: fix-cascade-delete-prices-category
      author: m_chelyshev
      preConditions:
        - onFail: CONTINUE
        - foreignKeyConstraintExists:
            foreignKeyName: fk_prices_category_visitors
      changes:
        - dropForeignKeyConstraint:
            baseTableName: prices
            constraintName: fk_prices_category_visitors
        - addForeignKeyConstraint:
            baseTableName: prices
            baseColumnNames: category_visitor_id
            constraintName: fk_prices_category_visitors
            referencedTableName: category_visitors
            referencedColumnNames: id
            onDelete: CASCADE
  - changeSet:
      id: fix-cascade-delete-visit-objects-v2
      author: m_chellyshev
      preConditions:
        onFail: CONTINUE
      changes:
        - dropForeignKeyConstraint:
            baseTableName: order_service_visit_object
            constraintName: fk_order_service_visit_object_vo
        - addForeignKeyConstraint:
            baseTableName: order_service_visit_object
            baseColumnNames: visit_object_id
            constraintName: fk_order_service_visit_object_vo
            referencedTableName: visit_objects
            referencedColumnNames: id
            onDelete: CASCADE
  - changeSet:
      id: fix-cascade-delete-ssvo-visit-object
      author: m_chellyshev
      preConditions:
        onFail: CONTINUE
      changes:
        - dropForeignKeyConstraint:
            baseTableName: sold_service_visit_object
            constraintName: fk_ssvo_visit_object
        - addForeignKeyConstraint:
            baseTableName: sold_service_visit_object
            baseColumnNames: visit_object_id
            constraintName: fk_ssvo_visit_object
            referencedTableName: visit_objects
            referencedColumnNames: id
            onDelete: CASCADE
  - changeSet:
      id: fix-cascade-delete-prices-visit-objects
      author: m_chellyshev
      preConditions:
        onFail: CONTINUE
      changes:
        - dropForeignKeyConstraint:
            baseTableName: prices
            constraintName: fk_prices_visit_objects
        - addForeignKeyConstraint:
            baseTableName: prices
            baseColumnNames: visit_object_id
            constraintName: fk_prices_visit_objects
            referencedTableName: visit_objects
            referencedColumnNames: id
            onDelete: CASCADE
  - changeSet:
      id: add-category-visitor-id-to-order-service-visitor
      author: m_chelyshev
      preConditions:
          - onFail: MARK_RAN
          - not:
              columnExists:
                tableName: order_service_visitor
                columnName: category_visitor_id
      changes:
        - addColumn:
            tableName: order_service_visitor
            columns:
              - column:
                  name: category_visitor_id
                  type: bigint
  - changeSet:
      id: fix-cascade-delete-prices-services
      author: m_chelyshev
      preConditions:
        onFail: CONTINUE
        foreignKeyConstraintExists:
          foreignKeyName: fk_prices_services
      changes:
        - dropForeignKeyConstraint:
            baseTableName: prices
            constraintName: fk_prices_services
        - addForeignKeyConstraint:
            baseTableName: prices
            baseColumnNames: service_id
            constraintName: fk_prices_services
            referencedTableName: services
            referencedColumnNames: id
            onDelete: CASCADE



  - changeSet:
      id: 020-add-root-user-permissions
      author: m_chelyshev
      preConditions:
        - onFail: MARK_RAN
        - not:
            columnExists:
              tableName: users
              columnName: is_root
      changes:
        # Добавление колонки is_root в таблицу users
        - addColumn:
            tableName: users
            columns:
              - column:
                  name: is_root
                  type: boolean
                  defaultValueBoolean: false
                  constraints:
                    nullable: false

        # Создание таблицы user_permissions
        - createTable:
            tableName: user_permissions
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
              - column:
                  name: user_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column: { name: can_manage_users, type: boolean, defaultValueBoolean: false, constraints: { nullable: false } }
              - column: { name: can_manage_services, type: boolean, defaultValueBoolean: false, constraints: { nullable: false } }
              - column: { name: can_manage_categories, type: boolean, defaultValueBoolean: false, constraints: { nullable: false } }
              - column: { name: can_manage_visit_objects, type: boolean, defaultValueBoolean: false, constraints: { nullable: false } }
              - column: { name: can_view_reports, type: boolean, defaultValueBoolean: false, constraints: { nullable: false } }
              - column: { name: can_manage_settings, type: boolean, defaultValueBoolean: false, constraints: { nullable: false } }
              - column: { name: can_manage_orders, type: boolean, defaultValueBoolean: false, constraints: { nullable: false } }
              - column: { name: can_export_data, type: boolean, defaultValueBoolean: false, constraints: { nullable: false } }
              - column: { name: can_import_data, type: boolean, defaultValueBoolean: false, constraints: { nullable: false } }

        # Добавление внешнего ключа
        - addForeignKeyConstraint:
            baseTableName: user_permissions
            baseColumnNames: user_id
            referencedTableName: users
            referencedColumnNames: id
            onDelete: CASCADE
            constraintName: fk_user_permissions_user

        # Создание индекса на user_id
        - createIndex:
            indexName: idx_user_permissions_user_id
            tableName: user_permissions
            columns:
              - column:
                  name: user_id

        # Добавление root-пользователя если он отсутствует
        - sql:
            splitStatements: false
            sql: |
              DO $$
              BEGIN
                  IF NOT EXISTS (SELECT 1 FROM users WHERE user_name = 'root') THEN
                      INSERT INTO users (user_name, password, role, full_name, created_at, is_root)
                      VALUES (
                          'root',
                          '$2a$12$K5Lzs0/CN7.sT.CG72FY9.8CjX7YMZerhVZcU.vWZbqECDCR3jgK6',
                          'ADMIN',
                          'Root Administrator',
                          NOW(),
                          TRUE
                      );

                      WITH root_user AS (SELECT id FROM users WHERE user_name = 'root' LIMIT 1)
                      INSERT INTO user_permissions (
                          user_id, can_manage_users, can_manage_services, can_manage_categories,
                          can_manage_visit_objects, can_view_reports, can_manage_settings,
                          can_manage_orders, can_export_data, can_import_data
                      )
                      SELECT id, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE
                      FROM root_user;

                  ELSE
                      UPDATE users SET is_root = TRUE WHERE user_name = 'root';

                      WITH root_user AS (SELECT id FROM users WHERE user_name = 'root' LIMIT 1)
                      INSERT INTO user_permissions (
                          user_id, can_manage_users, can_manage_services, can_manage_categories,
                          can_manage_visit_objects, can_view_reports, can_manage_settings,
                          can_manage_orders, can_export_data, can_import_data
                      )
                      SELECT id, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE
                      FROM root_user
                      WHERE NOT EXISTS (
                          SELECT 1 FROM user_permissions p JOIN root_user r ON p.user_id = r.id
                      );
                  END IF;
              END
              $$;

